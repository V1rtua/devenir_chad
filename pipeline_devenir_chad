pipeline {
    agent any
    parameters {
        string(name: "NOM", description: "Veuillez entrer votre nom")
        string(name: "PRENOM", description: "Veuillez entrer votre prénom")
        choice(name: "SEXE", choices: ["Homme","Femme","Chad"], description: "Veuillez choisir votre sexe")
        string(name: "TAILLE", description: "Veuillez entre votre taille en centimètres")
        string(name: "AGE", description: "Veuillez entrer votre âge")
        booleanParam(name: "PREMIERE_INSCRIPTION", description: "Est-ce votre première inscription ?")
        choice(name: "TYPE_ABONNEMENT", choices:["Basic","Prenium"], description: "Veuillez sélectionner l'abonnement que vous souhaitez prendre. L'abonnement Prenium inclut la mise en relation avec des salles de sport et des ditéticiens ainsi que les challenges mensuels.")
        string(name: "POIDS_BASE", description: "Veuillez entrer votre poids au moment du commencement du programme" )
        string(name: "POIDS_ACTUEL", description: "Veuillez entrer votre poids actuel. si c'est votre première inscription le poids est identique au poids de base")
        string(name: "OBJECTIF_POIDS", description: "Veuillez entrer votre objectif en terme de poids")
        choice(name: "ACTIVITE", choices: ["Sédentaire","Normal","Actif"], description: "Veuillez indiquer votre activité quotidienne")
        choice(name: "MOIS", choices: ["Mars","Avril","Mai"], description: "Veuillez entrer le mois de départ de votre programme")
        choice(name: "TYPE_REGIME", choices: ["Strict","Modéré"], description: "Veuillez sélectionner le type de régime souhaité")
        string(name: "SOMMEIL", description: "Veuillez indiquer le nombre d'heures de sommeil moyen que vous avez")
        string(name: "LITRES_EAU", description: "Veuillez indiquer le nombre de litres d'eau bu en moyenne par jour")
        booleanParam(name: "ACTIVITE_PHYS", description: "Veuillez indiquez si vous pratiquer une activité physique")
        choice(name: "NB_ACTIVITE", choices: ["0","1","2","3","4","5","6","7"], description: "Si oui, indiquez le nombre de jours par semaine dans lesquels vous pratiquez une activité physique")
        choice(name: "NB_FL", choices: ["0","1","2","3","4","5"], description: "Veuillez indiquer le nombre de fruits et légumes que vous consommez par jour")
        booleanParam(name: "ACCOMPAGNEMENT", description: "Souhaitez-vous être accompagné par un diététicien ou un nutritionniste ?")
        booleanParam(name: "SALLE", description: "Souhaitez vous adhérer à une des salles de sport de nos partenaires ?")
    }
    stages {
        stage ("Build-EPIC_US") {
            steps {
                // Construction des EPIC et des US

                echo "Construction de l'EPIC : Programme sur 3 mois"
                echo "Construction de l'US : Définir un objectif de poids"
                echo "Construction de l'US : Définir un nombre de calories à consommer"
                echo "Construction de l'US : Questionnaire sur les habitudes quotidiennes"
                echo "Construction de l'US : Différents types d'abonnement"
                echo "Construction de l'US : Feedback"

                sleep 5

                echo "Construction de l'EPIC : Journal de suivi du poids"
                echo "Construction de l'US : Vérification du respect de l'objectif du programme"
                echo "Construction de l'US : Proposer des repas sains"
                echo "Construction de l'US : Prévenir du grignotage"
                echo "Construction de l'US : Suivi de l'hydratation"
                echo "Construction de l'US : Suivi du sommeil"

                sleep 5

                echo "Construction de l'EPIC : Rapport calorique"
                echo "Construction de l'US : Conseiller des activités physiques"
                echo "Construction de l'US : Mettre en relation avec des salles de sport"
                echo "Construction de l'US : Mettre en relation avec des experts en alimentation"

                sleep 5

                echo "Construction de l'EPIC : Challenges Mensuels"
            }
        }
        stage ("Test-EPIC-Programme_3_mois"){
            steps{
                script {

                    // Variables qui récupère les informations rentrées en paramètres par l'utilisateur

                    def nom = "${params.NOM}"
                    def prenom = "${params.PRENOM}"
                    def sexe = "${params.SEXE}"
                    Integer taille = "${params.TAILLE}" as Integer
                    Integer age = "${params.AGE}" as Integer
                    def premiere_inscription = "${params.PREMIERE_INSCRIPTION}"
                    Integer poids_actuel = "${params.POIDS_ACTUEL}" as Integer
                    def activite = "${params.ACTIVITE}"
                    def type_regime = "${params.TYPE_REGIME}"
                    Integer objectif_poids = "${params.OBJECTIF_POIDS}" as Integer
                    

                    float besoin_calories
                    Integer poids_a_perdre = poids_actuel - objectif_poids
                    Integer obj_calories
                

                    // Message de bienvenue

                    echo "Bonjour $prenom, prêt à reprendre votre vie en main ?"

                    // Calcul des besoins en calories du métabolisme de base pour une femme

                    if (sexe == "Femme"){
                        float metabolisme = 9740 * poids_actuel + 172.9 * taille / 100 - 4.737 * age + 667.051
                        echo metabolisme.toString()

                        // Calcul des besoins en calories en prenant en compte le niveau d'activité pour une Femme
                        if (activite == "Sédentaire"){
                            besoin_calories = metabolisme * 1.55
                            echo besoin_calories.toString()
                        }
                        else if (activite == "Normal") {
                            besoin_calories = metabolisme * 1.78
                            echo besoin_calories.toString()
                        }
                        else {
                            besoin_calories = metabolisme * 2.10
                            echo besoin_calories.toString()
                        }
                    }

                    // Calcul des besoins en calories du métabolisme de base pour un Homme
                    else {
                        float metabolisme = 13.707 * poids_actuel + 492.3 * taille / 100 - 6.673 * age + 77.607
                        echo metabolisme.toString()

                        // Calcul des besoins en calories en prenant en compte le niveau d'activité pour un Homme
                        if (activite == "Sédentaire"){
                            besoin_calories = metabolisme * 1.56
                            echo besoin_calories.toString()
                        }
                        else if (activite == "Normal") {
                            besoin_calories = metabolisme * 1.64
                            echo besoin_calories.toString()
                        }
                        else {
                            besoin_calories = metabolisme * 1.82
                            echo besoin_calories.toString()
                        }
                    }

                    // Calcul permettant de déterminer le nombre de calories à perdre quotidiennement pour atteindre l'objectif

                    if (type_regime == "Modéré"){
                        if (256 * 90 < poids_a_perdre * 7680){
                            if (512 * 90 >= poids_a_perdre * 7680){
                            echo "Avec le régime "Modéré" vous ne pourrez pas atteindre votre objectif, toutefois si vous optez pour le type de régime 'Strict', vous pourrez atteindre votre objectif de perte de poids de $poids_a_perdre kg en 3 mois"
                            }
                            else {
                            echo "Votre objectif est impossible à atteindre dans le temps donné"
                            }  
                        }
                        else if (256 * 90 >= poids_a_perdre * 7680){
                            obj_calories = besoin_calories - 256
                            echo "Pour atteindre votre objectif, vous devez consommmer $obj_calories calories par jour pour perdre $poids_a_perdre kg en 3 mois"
                        }
                    }

                    if (type_regime == "Strict"){
                        if (512 * 90 < poids_a_perdre * 7680){
                            echo "Votre objectif est impossible à atteindre dans le temps donné"
                        }
                        else {
                            obj_calories = besoin_calories - 512
                            echo "Pour atteindre votre objectif, vous devez consommer $obj_calories calories par jour pour perdre $poids_a_perdre kg en 3 mois" 
                        }
                    }

                    if (premiere_inscription == false){
                        echo "Votre avis est important, quelle note donneriez-vous à notre application ?"
                    }


                }
            }
        }
    }
}
